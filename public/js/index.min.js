function hex2uI8Array(e){for(var t=new Uint8Array(Math.ceil(e.length/2)),r=0;r<t.length;r++)t[r]=parseInt(e.substr(2*r,2),16);return t}function uI8Array2hex(e){for(var t="",r=0;r<e.length;r++)e[r]<16&&(t+="0"),t+=e[r].toString(16);return t}BigNumber.config({DECIMAL_PLACES:8}),document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll("select");M.FormSelect.init(e)}),document.addEventListener("DOMContentLoaded",function(){var e=document.querySelectorAll(".modal");M.Modal.init(e)});var to_b58=function(e,t){var r,s,i,o,n=[],a="";for(r in e)for(s=0,a+=(i=e[r])||a.length^r?"":1;s in n||i;)i=(o=(o=n[s])?256*o+i:i)/58|0,n[s]=o%58,s++;for(;s--;)a+=t[n[s]];return a},from_b58=function(e,t){var r,s,i,o,n=[],a=[];for(r in e){if(s=0,(i=t.indexOf(e[r]))<0)return;for(i||a.length^r||a.push(0);s in n||i;)i=(o=(o=n[s])?58*o+i:i)>>8,n[s]=o%256,s++}for(;s--;)a.push(n[s]);return new Uint8Array(a)},MAP="123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz",convertAddr=function(e,t){if("BTCP"==e){if("00"==(o=uI8Array2hex(from_b58(t,MAP).slice(0,1)))){var r=forksAddrVersions[e].p2pkh;bitcoinjs.bitcoin.address.fromBase58Check(t)}else if("05"==o){r=forksAddrVersions[e].p2sh;bitcoinjs.bitcoin.address.fromBase58Check(t)}else if("1325"==uI8Array2hex(from_b58(t,MAP).slice(0,2)))r="00";else{if("13af"!=uI8Array2hex(from_b58(t,MAP).slice(0,2)))throw"unknown";r="05"}if("00"==r||"05"==r)var s=from_b58(t,MAP).slice(2,-4);else{if("1325"!=r&&"13af"!=r)throw"unknown";s=from_b58(t,MAP).slice(1,-4)}let i=r+uI8Array2hex(s),n=uI8Array2hex(bitcoinjs.bitcoin.crypto.sha256(bitcoinjs.bitcoin.crypto.sha256(hex2uI8Array(i)))).slice(0,8);return t=to_b58(hex2uI8Array(i+n),MAP),"00"!=r&&"05"!=r||bitcoinjs.bitcoin.address.fromBase58Check(t),t}var i=bitcoinjs.bitcoin.address.fromBase58Check(t);switch(i.version){case 0:var o=forksAddrVersions[e].p2pkh;break;case forksAddrVersions[e].p2pkh:o=0;break;case 5:o=forksAddrVersions[e].p2sh;break;case forksAddrVersions[e].p2sh:o=5;break;default:throw"unknown"}return bitcoinjs.bitcoin.address.toBase58Check(i.hash,o)},convertAddrs=function(e,t){return t.map(t=>convertAddr(e,t))},validAddr=function(e,t){try{var r;return"BTCP"==e?("1325"==(r=uI8Array2hex(from_b58(t,MAP).slice(0,2)))||"13af"==r)&&(convertAddr(e,t),!0):"BCH"==e?(bchaddr.toLegacyAddress(t),!0):((r=bitcoinjs.bitcoin.address.fromBase58Check(t).version)==forksAddrVersions[e].p2pkh||r==forksAddrVersions[e].p2sh)&&(convertAddr(e,t),!0)}catch(e){return!1}},mnemonics={english:new Mnemonic("english")},mnemonic=mnemonics.english,forksNames={BCH:"Bitcoin Cash",BTG:"Bitcoin Gold",BTX:"Bitcore",BCD:"Bitcoin Diamond",UBTC:"United Bitcoin",BCX:"Bitcoin X",SBTC:"Super Bitcoin",BTP:"Bitcoin Pay",BCK:"Bitcoin King",LBTC:"Lightning Bitcoin",B2X:"Bitcoin Segwit2x",BCI:"Bitcoin Interest",BTV:"Bitcoin Vote",BCA:"Bitcoin Atom",BTCP:"Bitcoin Private",BTW:"Bitcoin World"},forksHeight={BCH:478559,BTG:491407,BCD:495866,UBTC:498777,BCX:498888,SBTC:498888,BTP:499345,BTW:499777,LBTC:499999,B2X:501451,BCI:505083,BTV:505050,BCA:505888,BTCP:511346},insightExplorers={BCH:"https://blockdozer.com/api/addrs/",BTG:"https://btgexplorer.com/api/addrs/",BCD:"http://52.187.7.191:3001/insight-api/addrs/",UBTC:"/explorers/ubtc/addrs/",BCX:"/explorers/bcx/addrs/",SBTC:"http://block.superbtc.org/insight-api/addrs/",BTP:"http://exp.btceasypay.com/insight-api/addrs/",BCK:"https://browser.btcking.org/insight-api/addrs/",LBTC:"/explorers/lbtc/addrs/",B2X:"https://explorer.b2x-segwit.io/b2x-insight-api/addrs/",BCI:"https://explorer.bitcoininterest.io/api/addrs/",BTV:"https://block.bitvote.one/insight-api/addrs/",BTCP:"https://explorer.btcprivate.org/api/addrs/"},explorers={BCH:"https://blockdozer.com/tx/",BTG:"https://btgexplorer.com/tx/",BTX:"https://chainz.cryptoid.info/btx/tx.dws?",BCD:"http://explorer.btcd.io/#/TX?loading=true&TX=",UBTC:"https://block.bitbank.com/tx/ubtc/",BCX:"https://bcx.info/tx/",SBTC:"http://block.superbtc.org/tx/",BTP:"http://exp.btceasypay.com/insight/tx/",BTW:"#",BCK:"https://browser.btcking.org/tx/",LBTC:"https://explorer.lbtc.io/transinfo?param=",B2X:"https://explorer.b2x-segwit.io/tx/",BCI:"https://explorer.bitcoininterest.io/tx/",BTV:"https://block.bitvote.one/tx/",BCA:"https://explorer.bitcoinatom.io/tx/",BTCP:"https://explorer.btcprivate.org/tx/"},forksAddrVersions={BTG:{p2pkh:38,p2sh:23},BTP:{p2pkh:56,p2sh:58},BCI:{p2pkh:102,p2sh:23},BTV:{p2pkh:0,p2sh:5},BCH:{p2pkh:0,p2sh:5},BTX:{p2pkh:0,p2sh:5},SBTC:{p2pkh:0,p2sh:5},BCA:{p2pkh:23,p2sh:10},BCK:{p2pkh:0,p2sh:5},BTW:{p2pkh:73,p2sh:31},B2X:{p2pkh:0,p2sh:5},BTCP:{p2pkh:"1325",p2sh:"13af"},BCX:{p2pkh:75,p2sh:63},UBTC:{p2pkh:54,p2sh:8},LBTC:{p2pkh:0,p2sh:5},BCD:{p2pkh:0,p2sh:5}},forksRatio={BTF:1,BTW:1e4,BTG:1,BCX:1e4,B2X:1,UBTC:1,SBTC:1,BCD:10,BPA:1,BTN:1,BTH:100,BTV:1,BTT:1,BTX:.5,BTP:10,BCK:1,CDY:1e3,BTSQ:1e3,WBTC:100,BCH:1,BCA:1,BICC:1,BTCP:1,BCI:1,BBC:10,LBTC:1},main=new Vue({el:"main",data:{walletProvider:"",seed:"",mnemonicError:"",keyPairs:"[{},{}]",lastIndex:[0,0],inputs:null,pseudoBalances:{},BTCTransactions:[],forksUTXOS:{},pseudoUTXOS:null,forksBalances:null,forksNames:forksNames,lastRedeemsTXID:"",lastRedeemsError:!1,redeemFork:"",explorers:explorers,wif:"",forksRatio:forksRatio},watch:{walletProvider:function(e,t){switch(e){case"coinomi":setTimeout(()=>{$("#seed").parent().find("label").addClass("active"),$("#seed").focus()},100);break;case"wif":setTimeout(()=>{$("#wif").parent().find("label").addClass("active"),$("#wif").focus()},100)}},seed:function(e,t){this.keyPairs="[{},{}]",this.lastIndex=[0,0],this.inputs=[{},{}],this.pseudoBalances={},this.BTCTransactions=[],this.forksUTXOS={},this.pseudoUTXOS=null,this.forksBalances=null,this.lastRedeemsTXID="",this.lastRedeemsError=!1,this.redeemFork="",this.setMnemonicLanguage();var r=this.findPhraseErrors(e);if(r)return this.mnemonicError=r;this.mnemonicError="",this.generateAddresses(0)},wif:function(e,t){this.mnemonicError="",this.inputs={},e&&this.generateAddresses()},keyPairs:function(e,t){var r=JSON.parse(e);switch(this.walletProvider){case"wif":var s={addresses:Object.keys(r).join(","),from:-50,to:0,transactions:[]};this.queryBTCBlockahin(s).then(this.processBTCTransactions).catch();break;default:var i=this.lastIndex[0]>this.lastIndex[1]?this.lastIndex[0]:this.lastIndex[1],o=Object.keys(r[0]).slice(i,i+20),n=Object.keys(r[1]).slice(i,i+20);s={addresses:o.concat(n).join(","),from:-50,to:0,transactions:[]};this.queryBTCBlockahin(s).then(this.processBTCTransactions).catch()}}},methods:{generateAddresses:function(e){switch(this.walletProvider){case"wif":var t=this.wif.split(","),r={};try{t.forEach(e=>{var t=bitcoinjs.bitcoin.ECPair.fromWIF(e).getAddress();r[t]=e})}catch(e){return void(this.mnemonicError="Invalid key wif(s)")}this.keyPairs=JSON.stringify(r);break;default:var s=mnemonic.toSeed(this.seed),i=bitcoinjs.bitcoin.HDNode.fromSeedHex(s),o=this.getExtended(i);r=[{},{}];for(let t=0;t<2;t++)for(let s=e;s<e+20;s++){let e=this.getKeyPair(o,`${t}/${s}`);r[t][e.address]=e.WIF}var n=JSON.parse(this.keyPairs);Object.assign(n[0],n[0],r[0]),Object.assign(n[1],n[1],r[1]),this.keyPairs=JSON.stringify(n)}},queryBTCBlockahin:function(e){return new Promise((t,r)=>{void 0===e.resolve&&(e.resolve=t,e.reject=r),e.from+=50,e.to+=50,$.get("https://insight.bitpay.com/api/addrs/"+e.addresses+"/txs?from="+e.from+"&to="+e.to).done(t=>{e.transactions=e.transactions.concat(t.items),t.totalItems!=e.transactions.length?this.queryBTCBlockahin(e):e.resolve(e.transactions)}).fail(t=>{this.error="Error getting transaction history",e.reject()})})},processBTCTransactions:function(e){this.BTCTransactions.concat(e),"done"===this.getBTCInputs(e)&&(this.getPseudoUTXOSAndPseudoBalances(),this.queryForksUTXOS())},getBTCInputs:function(e){var t=JSON.parse(this.keyPairs);switch(this.walletProvider){case"wif":var r={};return e.forEach(e=>{e.vout.forEach(s=>{var i=Object.keys(t).indexOf(s.scriptPubKey.addresses[0]);i>-1&&(void 0===r[Object.keys(t)[i]]&&(r[Object.keys(t)[i]]=new Array),r[Object.keys(t)[i]].push(e))})}),Object.assign(this.inputs,this.inputs,r),"done";default:r=[{},{}];var s=[0,0];return e.forEach(e=>{e.vout.forEach(i=>{var o=[0,0];for(let n=0;n<2;n++)o[n]=Object.keys(t[n]).indexOf(i.scriptPubKey.addresses[0]),o[n]>-1&&(s[n]=o[n]>s[n]?o[n]:s[n],void 0===r[n][Object.keys(t[n])[o[n]]]&&(r[n][Object.keys(t[n])[o[n]]]=new Array),r[n][Object.keys(t[n])[o[n]]].push(e))})}),Object.assign(this.inputs[0],this.inputs[0],r[0]),Object.assign(this.inputs[1],this.inputs[1],r[1]),s[0]>this.lastIndex[0]||s[1]>this.lastIndex[1]?(this.lastIndex=s,s[0]>s[1]?this.generateAddresses(s[0]):this.generateAddresses(s[1])):(this.lastIndex=s,"done")}},getPseudoUTXOSAndPseudoBalances:function(){switch(this.walletProvider){case"wif":var e=this.inputs,t=Object.keys(this.inputs);break;default:e=this.inputs[0].concat(this.inputs[1]),t=Object.keys(e)}var r={},s={};Object.keys(forksHeight).forEach(i=>{t.forEach(t=>{e[t].forEach(e=>{e.vout.forEach((o,n)=>{o.scriptPubKey.addresses[0]===t&&(!o.spentHeight||o.spentHeight>forksHeight[i])&&e.blockheight<=forksHeight[i]&&(void 0===r[i]&&(r[i]="0"),r[i]=BigNumber(r[i]).plus(BigNumber(o.value).times(forksRatio[i])).toString(),void 0===s[i]&&(s[i]=[]),s[i].push({address:t,txid:e.txid,vout:n,scriptPubKey:o.scriptPubKey.hex,amount:BigNumber(o.value).times(BigNumber(this.forksRatio[i])).toString(),satoshis:BigNumber(o.value).times(BigNumber(this.forksRatio[i])).times(1e8).toString(),height:e.blockheight,confirmations:e.confirmations}))})})})}),this.pseudoUTXOS=s,this.pseudoBalances=r},queryForksUTXOS:function(){var e=JSON.parse(this.keyPairs);switch(this.walletProvider){case"wif":e=Object.keys(e);break;default:e=Object.keys(e[0]).concat(Object.keys(e[1]))}var t=[];Object.keys(this.pseudoBalances).forEach(r=>{t.push(new Promise((t,s)=>{var i={forkName:r,forkBalance:null};void 0!==insightExplorers[r]?(jQuery.get(insightExplorers[r]+convertAddrs(r,e).join(",")+"/utxo").done((e,s)=>{if("success"!==s)return t(i);if(0===e.length)return t({forkName:r,forkBalance:"0"});var o="0";try{e.forEach(e=>{o=BigNumber(o).plus(BigNumber(e.amount)).toString()})}catch(e){return t(i)}this.forksUTXOS[r]=e,t({forkName:r,forkBalance:o})}).fail(()=>{console.log("error"),t(i)}),setTimeout(()=>{t(i)},5e3)):t(i)}))}),Promise.all(t).then(e=>{var t={};e.forEach(e=>{e.forkBalance?t[e.forkName]=e.forkBalance:t[e.forkName]="?"}),this.forksBalances=t}).catch(console.log)},getExtended:function(e){for(var t="m/44'/0'/0'/".split("/"),r=e,s=0;s<t.length;s++){var i=t[s],o=parseInt(i);if(!isNaN(o)){var n="'"==i[i.length-1],a=!r.isNeutered();r=n&&!a?null:n?r.deriveHardened(o):r.derive(o)}}return r},getKeyPair:function(e,t){var r=(e=e.derivePath(t)).keyPair;return{address:r.getAddress().toString(),WIF:r.toWIF()}},setMnemonicLanguage:function(){var e=this.getLanguage();e in mnemonics||(mnemonics[e]=new Mnemonic(e)),mnemonic=mnemonics[e]},getLanguage:function(){var e=this.getLanguageFromPhrase();return 0==e.length&&(e=this.getLanguageFromUrl()),0==e.length&&(e="english"),e},getLanguageFromPhrase:function(e){var t="";if(this.seed.length>0){var r=this.phraseToWordArray(this.seed),s={};for(a in WORDLISTS){s[a]=0;for(var i=0;i<r.length;i++){WORDLISTS[a].indexOf(r[i])>-1&&s[a]++}var o=0,n=[];for(var a in s){var c=s[a];c>o?(o=c,n=[a]):c==o&&n.push(a)}}n.length>0&&(t=n[0],n.length>1&&(console.warn("Multiple possible languages"),console.warn(n)))}return t},getLanguageFromUrl:function(){for(var e in WORDLISTS)if(window.location.hash.indexOf(e)>-1)return e;return""},phraseToWordArray:function(e){for(var t=e.split(/\s/g),r=[],s=0;s<t.length;s++){var i=t[s];i.length>0&&r.push(i)}return r},findPhraseErrors:function(e){e=mnemonic.normalizeString(e);var t=this.phraseToWordArray(e);if(0==t.length)return"Blank mnemonic";for(var r=0;r<t.length;r++){var s=t[r],i=this.getLanguage();if(-1==WORDLISTS[i].indexOf(s))return s+" not in wordlist, did you mean "+this.findNearestWord(s)+"?"}var o=this.wordArrayToPhrase(t);return!mnemonic.check(o)&&"Invalid mnemonic"},findNearestWord:function(e){for(var t=this.getLanguage(),r=WORDLISTS[t],s=99,i=r[0],o=0;o<r.length;o++){var n=r[o];if(0==n.indexOf(e))return n;var a=Levenshtein.get(e,n);a<s&&(i=n,s=a)}return i},wordArrayToPhrase:function(e){var t=e.join(" ");return"japanese"==this.getLanguageFromPhrase(t)&&(t=e.join("　")),t},claimFrok:function(e){if(this.lastRedeemsTXID="",this.lastRedeemsError=!1,void 0!==this.forksUTXOS[e])var t=this.forksUTXOS[e];else{if(void 0===this.pseudoUTXOS[e])return;t=this.pseudoUTXOS[e]}var r=0;do{if(0==r)var s=window.prompt("Enter "+e+" address where you want to receive");else s=window.prompt("Enter a valid "+e+" address");if(!s)return;r++}while(0==validAddr(e,s));"BCH"==e&&(s=bchaddr.toLegacyAddress(s)),this.redeemFork=e;var i=JSON.parse(this.keyPairs);switch(this.walletProvider){case"wif":for(var o=0;o<t.length;o++){(void 0!==this.forksUTXOS[e]?convertAddrs(e,Object.keys(i)):Object.keys(i)).forEach((e,r)=>{e===t[o].address&&(t[o].address=Object.keys(i)[r],t[o].wif=Object.values(i)[r])})}break;default:for(o=0;o<t.length;o++)for(r=0;r<2;r++){(void 0!==this.forksUTXOS[e]?convertAddrs(e,Object.keys(i[r])):Object.keys(i[r])).forEach((e,s)=>{e===t[o].address&&(t[o].address=Object.keys(i[r])[s],t[o].wif=Object.values(i[r])[s])})}}M.Modal.getInstance($(".modal")).open(),$.post("/claim",{forkName:e,utxos:t,to:s},r=>{r.forEach((s,i)=>{if(!s.txNew)return this.lastRedeemsError=!0;var o=[];t.forEach((i,n)=>{i.txid!==s.txSpent?o.push(i):"?"!=this.forksBalances[e]?this.forksBalances[e]=BigNumber(this.forksBalances[e]).minus(i.amount).toString():r.length==t.length&&r.length==n+1&&(this.forksBalances[e]="0")}),t=o}),r=r.filter(e=>e.txNew),this.lastRedeemsTXID=JSON.stringify(r)})}},computed:{getKeyPairs:function(){return JSON.parse(this.keyPairs)}}});